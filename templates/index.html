<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Contables y Financieros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Librerías de Exportación -->
    <script src="https://cdn.jsdelivr.net/npm/table-to-excel@1.0.1/dist/tableToExcel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estilo para la animación de carga */
        .spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8" style="font-family: 'Inter', sans-serif; background-color: #f7f9fc;">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">

        <header class="bg-red-700 p-4 sm:p-6 text-white flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-yellow-300">
                REPORTES CONTABLES Y FINANCIEROS
            </h1>
            
            <div class="mt-3 sm:mt-0 flex items-center space-x-3">
                <label for="empresa-select" class="text-sm font-medium">Empresa Actual:</label>
                <!-- El JS poblará esta lista con las empresas y seleccionará una por defecto -->
                <select id="empresa-select" class="p-2 rounded-lg text-gray-800 bg-white shadow-md focus:ring-2 focus:ring-yellow-300 transition duration-150">
                    <!-- Opción inicial que será reemplazada por el JS -->
                    <option value="" disabled selected>Cargando empresas...</option>
                </select>
            </div>
        </header>

        <section class="p-4 sm:p-6 border-b border-gray-100">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Selección de Reporte Financiero</h2>
            <div id="report-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                
                <!-- VISTAS SQL (view_name) que debe buscar en el backend de Flask -->
                <!-- Nota: Deben coincidir con los nombres de las vistas en la BDD, p.ej., dbo.view_Balance_Comprobacion -->
                <button data-report="view_Balance_Comprobacion" data-title="Balance de Comprobación" class="report-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.02] flex items-center justify-center text-sm text-center">
                    <i class="ph ph-scale-balance text-xl mr-2"></i> Balance de Comprobación
                </button>
                
                <button data-report="view_Estado_Resultados" data-title="Estado de Resultados" class="report-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.02] flex items-center justify-center text-sm text-center">
                    <i class="ph ph-chart-line text-xl mr-2"></i> Estado de Resultados
                </button>
                
                <button data-report="view_Balance_Financiero" data-title="Balance Financiero" class="report-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.02] flex items-center justify-center text-sm text-center">
                    <i class="ph ph-currency-circle-dollar text-xl mr-2"></i> Balance Financiero
                </button>
                
                <button data-report="view_Movimientos_Cuentas" data-title="Movimientos de Cuentas" class="report-btn bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.02] flex items-center justify-center text-sm text-center">
                    <i class="ph ph-arrows-clockwise text-xl mr-2"></i> Reportes de Movimientos de Cuentas Corrientes
                </button>
                
            </div>
            
            <div class="mt-4 flex justify-end space-x-3">
                <button id="excel-export-btn" disabled
                        onclick="exportTableToExcel('report-table', document.getElementById('report-title').textContent)"
                        class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 shadow-md flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="ph ph-file-xls text-xl mr-1"></i> Exportar a Excel
                </button>
                <button id="pdf-export-btn" disabled
                        onclick="exportTableToPDF('report-table', document.getElementById('report-title').textContent)"
                        class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 shadow-md flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="ph ph-file-pdf text-xl mr-1"></i> Exportar a PDF
                </button>
            </div>
        </section>

        <main class="p-4 sm:p-6">
            <div id="report-card" class="report-card border border-gray-200 rounded-xl p-4 shadow-inner">
                <h3 id="report-title" class="text-xl font-bold text-gray-800 mb-4">Seleccione un reporte para empezar</h3>
                <div id="report-content" class="overflow-x-auto">
                    <div id="loading-message" class="text-center p-10 text-gray-500 hidden">
                        <i class="ph ph-spinner-gap spin text-4xl"></i>
                        <p class="mt-2">Cargando datos...</p>
                    </div>
                    <p id="initial-message" class="text-center p-10 text-gray-500">
                        Los resultados del reporte se mostrarán aquí. Asegúrese de que la conexión con la base de datos de Azure SQL sea correcta.
                    </p>
                    <table id="report-table" class="report-table w-full hidden min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr id="table-header"></tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
            
        </main>

    </div>
    
    <script>
    // --- Variables DOM ---
    const empresaSelect = document.getElementById('empresa-select');
    const reportButtons = document.querySelectorAll('.report-btn');
    const reportTitle = document.getElementById('report-title');
    const reportContent = document.getElementById('report-content');
    const loadingMessage = document.getElementById('loading-message');
    const initialMessage = document.getElementById('initial-message');
    const reportTable = document.getElementById('report-table');
    const tableHeader = document.getElementById('table-header');
    const tableBody = document.getElementById('table-body');
    const reportCard = document.getElementById('report-card');
    const excelExportBtn = document.getElementById('excel-export-btn');
    const pdfExportBtn = document.getElementById('pdf-export-btn');

    // Estado del reporte activo para recargar al cambiar de empresa
    let activeReport = {
        viewName: null,
        reportTitle: 'Seleccione un reporte para empezar'
    };

    // --- Utilidades de Visualización ---

    /**
     * Muestra el spinner de carga y oculta el contenido del reporte.
     * @param {boolean} isLoading
     */
    function toggleLoading(isLoading) {
        loadingMessage.classList.toggle('hidden', !isLoading);
        reportTable.classList.add('hidden');
        initialMessage.classList.add('hidden');
        reportCard.classList.toggle('opacity-50', isLoading);
        
        // Deshabilitar botones de exportación mientras carga
        excelExportBtn.disabled = isLoading;
        pdfExportBtn.disabled = isLoading;
    }

    /**
     * Formatea un valor como moneda hondureña (HNL).
     * @param {string|number} value
     * @returns {string}
     */
    function formatCurrency(value) {
        const num = parseFloat(String(value).replace(/[^0-9.-]+/g, ""));
        if (isNaN(num)) return value; // Devuelve el valor original si no es un número

        return num.toLocaleString('es-HN', {
            style: 'currency',
            currency: 'HNL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });
    }

    /**
     * Renderiza los datos del reporte en la tabla HTML.
     * @param {any[]} reportData - Array de objetos (filas) recibidos de la API.
     */
    function renderReportTable(reportData) {
        // 1. Manejo de Encabezados
        if (reportData.length === 0) {
            tableHeader.innerHTML = '<th>No hay datos para esta empresa o vista.</th>';
            tableBody.innerHTML = '';
            reportTable.classList.remove('hidden');
            excelExportBtn.disabled = true;
            pdfExportBtn.disabled = true;
            return;
        }

        const headers = Object.keys(reportData[0]);
        
        tableHeader.innerHTML = headers.map(header =>
            `<th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-100">${header.replace(/_/g, ' ')}</th>`
        ).join('');

        // 2. Renderizar Datos
        tableBody.innerHTML = reportData.map(rowObject => {
            const rowValues = Object.values(rowObject);
            
            // Heurística simple para determinar si es una fila de total
            const isTotalRow = rowValues.some(val =>
                typeof val === 'string' && (val.toLowerCase().includes('total') || val.toLowerCase().includes('sum'))
            );
            
            const rowClass = isTotalRow ? 'bg-yellow-50 font-bold text-gray-900 border-t-2 border-yellow-300' : 'bg-white text-gray-800 hover:bg-gray-50';
            
            return `<tr class="${rowClass}">` + rowValues.map(cell => {
                // Intenta formatear como moneda si el valor parece numérico
                let formattedCell = formatCurrency(cell);
                // Si el formato falló, usa el valor original o vacío
                if (formattedCell === cell) {
                    formattedCell = cell === null || cell === undefined ? '' : cell;
                }
                
                return `<td class="px-6 py-4 whitespace-nowrap text-sm">${formattedCell}</td>`;
            }).join('') + '</tr>';
        }).join('');

        // 3. Mostrar la tabla y habilitar exportación
        reportTable.classList.remove('hidden');
        excelExportBtn.disabled = false;
        pdfExportBtn.disabled = false;
    }


    // --- LÓGICA DE CONEXIÓN A FLASK API ---

    /**
     * Llama al endpoint de Flask para obtener la lista de empresas.
     */
    async function fetchEmpresas() {
        try {
            const response = await fetch('/api/empresas');
            const result = await response.json();
            
            if (result.status === 'success' && result.data && result.data.length > 0) {
                return result.data.map(empresa => ({
                    id: empresa.REG_Empresa,
                    name: empresa.Nombre_empresa
                }));
            } else {
                console.error("Error al obtener empresas:", result.message || "Respuesta API inesperada.");
                return [];
            }
        } catch (error) {
            console.error('Fallo la conexión con el API /api/empresas:', error);
            reportTitle.textContent = `ERROR DE CONEXIÓN: No se pudo conectar al servidor de Flask.`;
            return [];
        }
    }

    /**
     * Llama al endpoint genérico de Flask para obtener el reporte de una vista SQL.
     * @param {string} viewName - El nombre de la vista SQL a consultar (ej: view_Balance_Comprobacion).
     * @param {number} companyId - El ID de la empresa para filtrar.
     */
    async function fetchReporte(viewName, companyId) {
        toggleLoading(true);
        const endpoint = `/api/reporte-vista/${viewName}?empresa_id=${companyId}`;
        
        try {
            const response = await fetch(endpoint);
            const result = await response.json();
            
            if (result.status === 'success') {
                return result.data;
            } else {
                // Manejar errores de SQL como 'Vista no encontrada' (404)
                throw new Error(result.message || "Error desconocido al cargar el reporte.");
            }
        } catch (error) {
            console.error('Error en fetchReporte:', error);
            // Mostrar mensaje de error en el título del reporte
            reportTitle.textContent = `ERROR: ${error.message}`;
            reportTable.classList.add('hidden'); // Ocultar tabla si hay error
            initialMessage.classList.remove('hidden'); // Mostrar el área de contenido vacío
            return null;
        } finally {
            toggleLoading(false);
        }
    }

    // --- LÓGICA DE UI Y EVENTOS ---

    /**
     * Maneja el clic en los botones de reporte.
     * @param {Event} event
     */
    const handleReportButtonClick = async (event) => {
        const reportBtn = event.currentTarget;
        const viewName = reportBtn.getAttribute('data-report');
        const reportTitleText = reportBtn.getAttribute('data-title');
        
        const companySelect = document.getElementById('empresa-select');
        const companyId = companySelect.value;
        const companyName = companySelect.options[companySelect.selectedIndex].text;

        if (!companyId) {
            reportTitle.textContent = 'Error: Seleccione una empresa válida.';
            return;
        }
        
        // 1. Actualizar estado activo
        activeReport.viewName = viewName;
        activeReport.reportTitle = reportTitleText;

        // 2. Ejecutar fetch
        const data = await fetchReporte(viewName, companyId);
        
        if (data) {
            reportTitle.textContent = `${reportTitleText} - Empresa: ${companyName}`;
            renderReportTable(data);
        } else {
            // Si data es null, el error ya se mostró en fetchReporte
        }
    };

    /**
     * Carga las empresas en el selector.
     */
    const loadCompanies = async () => {
        const companies = await fetchEmpresas();
        const select = document.getElementById('empresa-select');
        select.innerHTML = ''; // Limpiar opciones existentes

        if (companies.length === 0) {
            select.innerHTML = '<option value="" disabled selected>No se encontraron empresas.</option>';
            reportTitle.textContent = 'Error al cargar empresas. Revise la conexión SQL y la tabla Principal.';
            return;
        }

        companies.forEach(company => {
            const option = document.createElement('option');
            option.value = company.id;
            option.textContent = company.name;
            select.appendChild(option);
        });

        // Seleccionar la primera por defecto e inicializar el título
        select.value = companies[0].id;
        reportTitle.textContent = 'Seleccione un reporte para la empresa ' + companies[0].name;
    };


    // --- FUNCIONES DE EXPORTACIÓN (EXISTENTES) ---

    // Exportar a Excel
    window.exportTableToExcel = (tableId, filename = 'reporte') => {
        const table = document.getElementById(tableId);
        if (table.classList.contains('hidden') || table.tBodies[0].rows.length === 0) {
                console.warn("No hay tabla visible o datos para exportar a Excel.");
                return;
        }
        TableToExcel.convert(table, {
            name: `${filename}.xlsx`,
            sheet: {
                name: 'Reporte'
            }
        });
    };

    // Exportar a PDF (Usando html2canvas y jspdf.autotable para mejor calidad)
    window.exportTableToPDF = async (tableId, filename = 'reporte') => {
        const table = document.getElementById(tableId);
        if (table.classList.contains('hidden') || table.tBodies[0].rows.length === 0) {
                console.warn("No hay tabla visible o datos para exportar a PDF.");
                return;
        }
        
        // La librería jspdf.umd.min.js expone jsPDF globalmente
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // 'l' para horizontal, A4
        
        const finalFilename = filename.replace(/[^a-z0-9]/gi, '_');

        doc.text(filename, 14, 15);
        
        // Se puede añadir la fecha y empresa aquí también si se quiere

        doc.autoTable({
            html: `#${tableId}`,
            startY: 20, // Empieza la tabla después del título
            theme: 'striped',
            headStyles: { fillColor: [200, 50, 50] }, // Color para encabezados
            styles: { fontSize: 8 },
            margin: { top: 10, left: 10, right: 10, bottom: 10 }
        });

        doc.save(`${finalFilename}.pdf`);
    };

    // --- INICIALIZACIÓN DE LA APP ---
    window.onload = () => {
        // 1. Cargar las empresas
        loadCompanies();

        // 2. Asignar Eventos a Botones de Reporte
        document.querySelectorAll('.report-btn').forEach(button => {
            button.addEventListener('click', handleReportButtonClick);
        });

        // 3. Asignar Evento al Selector de Empresa
        document.getElementById('empresa-select').addEventListener('change', async (e) => {
            const selectedName = e.target.options[e.target.selectedIndex].text;
            reportTitle.textContent = `Seleccione un reporte para la empresa ${selectedName}`;
            
            // Si había un reporte activo, recargarlo con la nueva empresa
            if (activeReport.viewName) {
                // Actualizamos el título inmediatamente
                reportTitle.textContent = `${activeReport.reportTitle} - Empresa: ${selectedName} (Recargando...)`;
                
                // Recargamos el reporte
                const data = await fetchReporte(activeReport.viewName, e.target.value);
                
                if (data) {
                    reportTitle.textContent = `${activeReport.reportTitle} - Empresa: ${selectedName}`;
                    renderReportTable(data);
                } else {
                    // Si falla, el título ya tiene el mensaje de error
                }

            } else {
                // Si no había reporte activo, limpiar la vista
                document.getElementById('report-table').classList.add('hidden');
                document.getElementById('initial-message').classList.remove('hidden');
                excelExportBtn.disabled = true;
                pdfExportBtn.disabled = true;
            }
        });
    };

    </script>
    
</body>
</html>
